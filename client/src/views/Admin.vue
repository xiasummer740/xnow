<script setup>
import { ref, computed, onMounted, onUnmounted, watch, nextTick } from 'vue';
import { useUserStore } from '../stores/user';
import { useUiStore } from '../stores/ui'; 
import { useAppStore } from '../stores/app';

const userStore = useUserStore(); const ui = useUiStore(); const app = useAppStore();
const loading = ref(false); const syncing = ref(false); const editorRef = ref(null);
const data = ref({ upstreamBalance: { balance: '0.00' }, users: [], orders: [], transactions: [], config: {}, totalOrders: 0 });

const form = ref({
    global_multiplier: 2.0, agent_discount: 0.8, announcement: '', site_name: 'XNOW', site_logo: '/logo.png',
    upstream_url: '', upstream_key: '', tg_bot_token: '', tg_chat_id: '', tg_bot_link: 'https://t.me/Xnow001Bot',
    cryptomus_id: '', cryptomus_key: '', bufpay_id: '', bufpay_key: '', smtp_host: '', smtp_port: '', smtp_email: '', smtp_pass: '', usdt_image_url: ''
});

const fundModal = ref({ show: false, userId: null, phone: '', type: 'add', amount: 100 });
const roleModal = ref({ show: false, userId: null, phone: '', role: 'user', currentExpire: null, addDays: 0 });

const searchTx = ref(''); const pageTx = ref(1); const sizeTx = ref(10);
const filteredTx = computed(() => { if (!searchTx.value) return data.value.transactions || []; const lower = searchTx.value.toLowerCase(); return data.value.transactions.filter(t => String(t.user_id).includes(lower) || String(t.phone).includes(lower) || String(t.description).toLowerCase().includes(lower)); });
const totalPageTx = computed(() => Math.ceil(filteredTx.value.length / sizeTx.value) || 1);
const pagedTx = computed(() => { const start = (pageTx.value - 1) * sizeTx.value; return filteredTx.value.slice(start, start + sizeTx.value); });
watch([searchTx, sizeTx], () => pageTx.value = 1);

const searchUser = ref(''); const pageUser = ref(1); const sizeUser = ref(10);
const filteredUsers = computed(() => { if (!searchUser.value) return data.value.users || []; const lower = searchUser.value.toLowerCase(); return data.value.users.filter(u => String(u.id).includes(lower) || String(u.phone).includes(lower) || String(u.register_ip).includes(lower) || (u.email && String(u.email).toLowerCase().includes(lower))); });
const totalPageUser = computed(() => Math.ceil(filteredUsers.value.length / sizeUser.value) || 1);
const pagedUsers = computed(() => { const start = (pageUser.value - 1) * sizeUser.value; return filteredUsers.value.slice(start, start + sizeUser.value); });
watch([searchUser, sizeUser], () => pageUser.value = 1);

const searchOrder = ref(''); const pageOrder = ref(1); const sizeOrder = ref(10);
const filteredOrders = computed(() => { if (!searchOrder.value) return data.value.orders || []; const lower = searchOrder.value.toLowerCase(); return data.value.orders.filter(o => String(o.order_no).toLowerCase().includes(lower) || String(o.service_name).toLowerCase().includes(lower) || String(o.user_id).includes(lower)); });
const totalPageOrder = computed(() => Math.ceil(filteredOrders.value.length / sizeOrder.value) || 1);
const pagedOrders = computed(() => { const start = (pageOrder.value - 1) * sizeOrder.value; return filteredOrders.value.slice(start, start + sizeOrder.value); });
watch([searchOrder, sizeOrder], () => pageOrder.value = 1);

const formatTime = (isoString) => { if (!isoString) return '--'; try { return new Date(isoString).toLocaleString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false, timeZone: 'Asia/Shanghai' }); } catch (e) { return isoString; } };

const fetchDashboard = async (showLoading = true) => {
    if (showLoading) loading.value = true;
    try {
        const res = await fetch(`/api/admin/dashboard?_t=${new Date().getTime()}`, { headers: { 'Authorization': `Bearer ${userStore.token}`, 'Cache-Control': 'no-store' } });
        const json = await res.json();
        if (json.status === 'success') {
            data.value = json;
            if (data.value.users) { data.value.users.forEach(u => { u.customInput = u.custom_multiplier; }); }
            if (showLoading && json.config) {
                Object.keys(form.value).forEach(key => { if (json.config[key] !== undefined) form.value[key] = json.config[key]; });
                if (editorRef.value && !editorRef.value.innerHTML) { editorRef.value.innerHTML = form.value.announcement; }
            }
        }
    } catch (e) { ui.showToast('æ•°æ®åŒæ­¥å¤±è´¥', 'error'); } finally { if (showLoading) loading.value = false; syncing.value = false; }
};

const saveConfig = async () => { try { await fetch('/api/admin/config/update', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${userStore.token}` }, body: JSON.stringify(form.value) }); ui.showToast('ç³»ç»Ÿå…¨å±€é…ç½®å·²ä¿å­˜', 'success'); app.fetchConfig(); } catch (e) { ui.showToast('ä¿å­˜å¤±è´¥', 'error'); } };
const handleLogoUpload = (event) => { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { form.value.site_logo = e.target.result; ui.showToast('Logo è¯»å–æˆåŠŸï¼Œè¯·ç‚¹å‡»ä¿å­˜', 'success'); }; reader.readAsDataURL(file); };
const execCmd = (cmd, val = null) => { document.execCommand(cmd, false, val); syncEditorContent(); };
const syncEditorContent = () => { if (editorRef.value) form.value.announcement = editorRef.value.innerHTML; };
const insertLink = () => { const url = prompt('è¯·è¾“å…¥é“¾æ¥åœ°å€ (éœ€åŒ…å« http:// æˆ– https://):', 'https://'); if (url) execCmd('createLink', url); };
const insertImage = () => { const url = prompt('è¯·è¾“å…¥å›¾ç‰‡ç½‘ç»œåœ°å€ (URL):', 'https://'); if (url) execCmd('insertImage', url); };

const openFundModal = (user, type) => { fundModal.value = { show: true, userId: user.id, phone: user.phone, type: type, amount: 100 }; };
const submitFund = async () => {
    if (fundModal.value.amount <= 0) return ui.showToast('é‡‘é¢å¿…é¡»å¤§äº0', 'error');
    try {
        const finalAmount = fundModal.value.type === 'add' ? fundModal.value.amount : -fundModal.value.amount;
        await fetch('/api/admin/user/update', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${userStore.token}` }, body: JSON.stringify({ userId: fundModal.value.userId, type: 'fund', amount: finalAmount, phone: fundModal.value.phone }) });
        ui.showToast('èµ„é‡‘æ“ä½œæˆåŠŸ', 'success'); fundModal.value.show = false; fetchDashboard(false);
    } catch (e) { ui.showToast('æ“ä½œå¤±è´¥', 'error'); }
};

const getDefaultMultiplier = (u) => {
    const base = parseFloat(form.value.global_multiplier || 2.0);
    const agentDiscount = parseFloat(form.value.agent_discount || 0.8);
    if (u.role === 'admin' || u.role === 'super_admin') return (1.0).toFixed(2);
    if (u.role === 'agent') return (base * agentDiscount).toFixed(2);
    return base.toFixed(2);
};

const saveMultiplier = async (u) => {
    if (!u.customInput || u.customInput <= 0) return ui.showToast('è¯·è¾“å…¥æœ‰æ•ˆå€ç‡', 'error');
    try {
        const res = await fetch('/api/admin/user/update', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${userStore.token}` }, body: JSON.stringify({ userId: u.id, type: 'multiplier', multiplier: u.customInput, phone: u.phone }) });
        const json = await res.json();
        if (json.status === 'success') { ui.showToast('å€ç‡è‡ªå®šä¹‰ç”Ÿæ•ˆ', 'success'); fetchDashboard(false); }
        else { ui.showToast(json.message || 'æ›´æ–°å¤±è´¥', 'error'); }
    } catch (e) { ui.showToast('ç½‘ç»œå¼‚å¸¸', 'error'); }
};

const resetMultiplier = async (u) => {
    try {
        const res = await fetch('/api/admin/user/update', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${userStore.token}` }, body: JSON.stringify({ userId: u.id, type: 'multiplier', multiplier: 'default', phone: u.phone }) });
        const json = await res.json();
        if (json.status === 'success') { ui.showToast('å·²æ— ç¼æ¢å¤ç³»ç»Ÿé»˜è®¤å€ç‡', 'success'); fetchDashboard(false); }
    } catch (e) {}
};

const openRoleModal = (u) => {
    if (['admin', 'super_admin'].includes(u.role)) return ui.showToast('ç®¡ç†å‘˜èº«ä»½å—åˆ°ç¥åœ£ä¿æŠ¤ï¼Œä¸å¯å˜åŠ¨', 'error');
    roleModal.value = { show: true, userId: u.id, phone: u.phone, role: u.role, currentExpire: u.vip_expire_at, addDays: 0 };
};

const submitRole = async () => {
    try {
        const res = await fetch('/api/admin/user/role', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${userStore.token}` }, body: JSON.stringify({ userId: roleModal.value.userId, role: roleModal.value.role, addDays: roleModal.value.addDays }) });
        const json = await res.json();
        if (json.status === 'success') { ui.showToast('ç‰¹æƒä¸æ—¶é•¿è°ƒåº¦æˆåŠŸ', 'success'); roleModal.value.show = false; fetchDashboard(false); }
        else { ui.showToast(json.message || 'è°ƒåº¦å¤±è´¥', 'error'); }
    } catch (e) { ui.showToast('ç½‘ç»œè¯·æ±‚å¼‚å¸¸', 'error'); }
};

let refreshTimer = null; watch(() => app.globalRefreshTrigger, () => fetchDashboard(false));
onMounted(() => { fetchDashboard(true); refreshTimer = setInterval(() => { syncing.value = true; fetchDashboard(false); }, 10000); });
onUnmounted(() => { if (refreshTimer) clearInterval(refreshTimer); });
</script>

<template>
    <div class="max-w-7xl mx-auto space-y-6 pb-20 relative z-10">
        <div v-if="loading" class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm z-50 flex flex-col items-center pt-32 rounded-3xl"><div class="w-16 h-16 border-4 border-amber-400 border-t-transparent rounded-full animate-spin shadow-[0_0_20px_rgba(251,191,36,0.5)]"></div><div class="text-amber-400 font-black mt-6 text-lg tracking-widest animate-pulse">æ­£åœ¨ä¸ä¸Šæ¸¸è¿›è¡Œç»å¯¹å®æ—¶åŒæ­¥...</div><div class="text-slate-400 text-xs mt-2">æ‹‰å–æœ€æ–°æ•°æ®ä¸­ï¼Œè¯·ç¨å€™</div></div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">
            <div class="bg-slate-800/80 border border-slate-700 p-6 rounded-2xl shadow-lg relative overflow-hidden"><div class="absolute -right-4 -top-4 text-green-500/10 text-8xl">ğŸ’°</div><div class="text-slate-400 text-xs font-bold mb-1 flex items-center justify-between"><span>ä¸Šæ¸¸ä½™é¢ (API)</span><span v-if="syncing" class="text-[9px] text-amber-500 font-bold animate-pulse">â³ åŒæ­¥ä¸­...</span><span v-else class="flex items-center text-[9px] bg-green-500/20 text-green-400 px-1.5 py-0.5 rounded-full border border-green-500/30"><span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse mr-1"></span>LIVE</span></div><div class="text-3xl font-black text-green-400 font-mono mt-2">{{ data.upstreamBalance?.balance || '0.00' }}</div></div>
            <div class="bg-slate-800/80 border border-slate-700 p-6 rounded-2xl shadow-lg relative overflow-hidden"><div class="absolute -right-4 -top-4 text-amber-500/10 text-8xl">ğŸ¦</div><div class="text-slate-400 text-xs font-bold mb-1">æœ¬ç«™ç©å®¶é‡‘åº“æ±‡æ€»</div><div class="text-3xl font-black text-amber-400 font-mono mt-2">{{ app.formatMoney(data.users ? data.users.reduce((acc, u) => acc + parseFloat(u.balance || 0), 0) : 0) }}</div></div>
            <div class="bg-slate-800/80 border border-slate-700 p-6 rounded-2xl shadow-lg relative overflow-hidden"><div class="absolute -right-4 -top-4 text-blue-500/10 text-8xl">ğŸ“ˆ</div><div class="text-slate-400 text-xs font-bold mb-1">å®æ—¶æ±‡ç‡ (USD/CNY)</div><div class="text-3xl font-black text-blue-400 font-mono mt-2 flex items-baseline">{{ app.exchangeRate }}</div></div>
            <div class="bg-slate-800/80 border border-slate-700 p-6 rounded-2xl shadow-lg relative overflow-hidden"><div class="absolute -right-4 -top-4 text-purple-500/10 text-8xl">ğŸ“¦</div><div class="text-slate-400 text-xs font-bold mb-1">å…¨ç«™ç´¯è®¡å¤„ç†è®¢å•</div><div class="text-3xl font-black text-purple-400 font-mono mt-2">{{ data.totalOrders || '0' }}</div></div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-slate-800/80 border border-slate-700 p-6 rounded-3xl shadow-xl flex flex-col justify-between space-y-6">
                <div>
                    <h3 class="text-lg font-bold text-white mb-6 flex items-center"><span class="text-amber-400 mr-2">âš™ï¸</span> å…¨å±€ä»·æ ¼ä¸æŠ˜æ‰£è°ƒæ§ä¸­æ¢</h3>
                    <div class="flex justify-between items-end mb-2"><span class="text-sm text-slate-400">å…¨å±€åŸºç¡€é”€å”®å€ç‡ (1-10x)</span><span class="text-2xl font-black text-amber-400">{{ form.global_multiplier }}x</span></div>
                    <input type="range" min="1" max="10" step="0.1" v-model="form.global_multiplier" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-amber-400 mb-6">
                    <div class="flex justify-between items-end mb-2"><span class="text-sm text-slate-400">è‡³å°Šä»£ç†ä¸“å±æŠ˜æ‰£ (æŠ˜ä¸ŠæŠ˜æ¯”ä¾‹)</span><span class="text-xl font-black text-emerald-400">{{ Math.round(form.agent_discount * 100) }}% ({{ form.agent_discount * 10 }} æŠ˜)</span></div>
                    <input type="range" min="0.1" max="1.0" step="0.05" v-model="form.agent_discount" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-emerald-400 mb-8">
                    <div class="bg-slate-900/50 p-4 rounded-xl border border-slate-700/50 space-y-3">
                        <div class="flex justify-between items-center"><span class="badge-agent px-2 py-0.5 text-[10px]">è‡³å°Šä»£ç† ({{ Math.round(form.agent_discount * 100) }}%)</span><span class="font-mono font-bold text-emerald-400">x {{ (form.global_multiplier * form.agent_discount).toFixed(2) }}</span></div>
                        <div class="flex justify-between items-center"><span class="badge-gold px-2 py-0.5 text-[10px]">é»„é‡‘ç”¨æˆ·</span><span class="font-mono font-bold text-slate-300">x {{ parseFloat(form.global_multiplier).toFixed(2) }}</span></div>
                    </div>
                </div>
                <div class="border-t border-slate-700 pt-6">
                    <h3 class="text-sm font-bold text-white mb-4 flex items-center"><span class="text-blue-400 mr-2">ğŸ¨</span> ç½‘ç«™å“ç‰Œå®šåˆ¶</h3>
                    <div class="space-y-4">
                        <div><label class="block text-xs text-slate-400 mb-1">ç½‘ç«™åç§°</label><input type="text" v-model="form.site_name" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-2 text-white outline-none text-sm focus:border-amber-400 transition"></div>
                        <div><label class="block text-xs text-slate-400 mb-2">è‡ªå®šä¹‰ Logo</label><div class="flex items-center space-x-4"><img v-if="form.site_logo" :src="form.site_logo" class="max-h-12 max-w-[120px] object-contain bg-slate-800 p-1 rounded border border-slate-600"><div class="relative overflow-hidden bg-slate-700 hover:bg-slate-600 text-white text-xs font-bold py-2 px-4 rounded-lg cursor-pointer transition"><span>ä¸Šä¼ æœ¬åœ°å›¾ç‰‡</span><input type="file" accept="image/*" @change="handleLogoUpload" class="absolute inset-0 opacity-0 cursor-pointer w-full h-full"></div></div></div>
                    </div>
                </div>
                <button @click="saveConfig" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-xl transition shadow-[0_0_15px_rgba(37,99,235,0.4)]">ä¿å­˜å…¨å±€ä»·æ ¼ä¸å“ç‰Œ</button>
            </div>

            <div class="bg-slate-800/80 border border-slate-700 p-6 rounded-3xl shadow-xl flex flex-col">
                <h3 class="text-lg font-bold text-white mb-4 flex items-center"><span class="text-pink-500 mr-2">ğŸ“¢</span> å…¨ç«™å…¬å‘Šç¼–è¾‘</h3>
                <div class="flex flex-wrap items-center gap-1.5 bg-slate-900/80 p-2 rounded-t-xl border border-slate-600 border-b-0 select-none">
                    <button @click="execCmd('bold')" class="px-2 py-1 bg-slate-700 hover:bg-slate-600 rounded text-white font-bold text-xs shadow-sm" title="åŠ ç²—">B</button><button @click="execCmd('italic')" class="px-2 py-1 bg-slate-700 hover:bg-slate-600 rounded text-white italic text-xs shadow-sm" title="æ–œä½“">I</button><button @click="execCmd('underline')" class="px-2 py-1 bg-slate-700 hover:bg-slate-600 rounded text-white underline text-xs shadow-sm" title="ä¸‹åˆ’çº¿">U</button><button @click="execCmd('strikeThrough')" class="px-2 py-1 bg-slate-700 hover:bg-slate-600 rounded text-white line-through text-xs shadow-sm" title="åˆ é™¤çº¿">S</button><div class="w-px h-4 bg-slate-600 mx-1"></div><button @click="execCmd('justifyLeft')" class="px-2 py-1 bg-slate-700 hover:bg-slate-600 rounded text-white text-xs shadow-sm" title="å·¦å¯¹é½">â‡¤</button><button @click="execCmd('justifyCenter')" class="px-2 py-1 bg-slate-700 hover:bg-slate-600 rounded text-white text-xs shadow-sm" title="å±…ä¸­">â‡¥â‡¤</button><button @click="execCmd('justifyRight')" class="px-2 py-1 bg-slate-700 hover:bg-slate-600 rounded text-white text-xs shadow-sm" title="å³å¯¹é½">â‡¥</button><div class="w-px h-4 bg-slate-600 mx-1"></div><button @click="execCmd('insertUnorderedList')" class="px-2 py-1 bg-slate-700 hover:bg-slate-600 rounded text-white text-xs shadow-sm" title="æ— åºåˆ—è¡¨">â€¢</button><button @click="execCmd('insertOrderedList')" class="px-2 py-1 bg-slate-700 hover:bg-slate-600 rounded text-white text-xs shadow-sm" title="æœ‰åºåˆ—è¡¨">1.</button><div class="w-px h-4 bg-slate-600 mx-1"></div><select @change="e => { execCmd('fontSize', e.target.value); e.target.selectedIndex=0 }" class="bg-slate-700 text-white text-xs rounded px-1 py-1 outline-none shadow-sm cursor-pointer"><option value="">å­—å·</option><option value="1">æå°</option><option value="3">æ ‡å‡†</option><option value="5">å¤§</option><option value="7">ç‰¹å¤§</option></select><select @change="e => { execCmd('foreColor', e.target.value); e.target.selectedIndex=0 }" class="bg-slate-700 text-white text-xs rounded px-1 py-1 outline-none shadow-sm cursor-pointer"><option value="">A é¢œè‰²</option><option value="#ef4444">ğŸ”´ çº¢</option><option value="#f59e0b">ğŸŸ  æ©™</option><option value="#fbbf24">ğŸŸ¡ é»„</option><option value="#22c55e">ğŸŸ¢ ç»¿</option><option value="#3b82f6">ğŸ”µ è“</option><option value="#a855f7">ğŸŸ£ ç´«</option><option value="#ffffff">âšª ç™½</option></select><select @change="e => { execCmd('hiliteColor', e.target.value); e.target.selectedIndex=0 }" class="bg-slate-700 text-white text-xs rounded px-1 py-1 outline-none shadow-sm cursor-pointer"><option value="">èƒŒæ™¯è‰²</option><option value="#ef4444">ğŸ”´ çº¢</option><option value="#f59e0b">ğŸŸ  æ©™</option><option value="#fbbf24">ğŸŸ¡ é»„</option><option value="#22c55e">ğŸŸ¢ ç»¿</option><option value="#3b82f6">ğŸ”µ è“</option><option value="#1e293b">âš« é»‘</option></select><div class="w-px h-4 bg-slate-600 mx-1"></div><button @click="insertLink" class="px-2 py-1 bg-slate-700 hover:bg-slate-600 rounded text-white text-xs shadow-sm" title="æ’å…¥é“¾æ¥">ğŸ”—</button><button @click="insertImage" class="px-2 py-1 bg-slate-700 hover:bg-slate-600 rounded text-white text-xs shadow-sm" title="æ’å…¥å›¾ç‰‡">ğŸ–¼ï¸</button><button @click="execCmd('removeFormat')" class="px-2 py-1 bg-red-500/20 hover:bg-red-500/40 text-red-400 rounded text-xs ml-auto border border-red-500/30 transition shadow-sm" title="æ¸…é™¤æ ¼å¼">ğŸ§¹ æ¸…é™¤æ ¼å¼</button>
                </div>
                <div ref="editorRef" contenteditable="true" @input="syncEditorContent" @blur="syncEditorContent" class="w-full h-48 bg-slate-900/80 border border-slate-600 rounded-b-xl p-4 text-slate-200 outline-none focus:border-pink-500 transition overflow-y-auto custom-scrollbar mb-3 text-sm leading-relaxed" style="min-height: 12rem;"></div>
                
                <div class="flex justify-between items-center mb-6">
                    <span class="text-xs text-slate-500">è¶…å¼ºå¯Œåª’ä½“æ”¯æŒï¼Œå›¾æ–‡å¹¶èŒ‚</span>
                    <button @click="saveConfig" class="px-6 py-2.5 rounded-xl bg-amber-400 hover:bg-amber-500 text-slate-900 font-black transition shadow-[0_0_15px_rgba(251,191,36,0.3)]">åŒæ­¥å‘å¸ƒå…¬å‘Š</button>
                </div>

                <hr class="border-slate-700 mb-4">

                <div>
                    <h4 class="text-sm font-bold text-slate-300 mb-3 flex items-center"><span class="text-green-400 mr-2">ğŸ–¼ï¸</span> USDT ä¸“å±æ•™ç¨‹å›¾é…ç½®</h4>
                    <div class="flex space-x-3">
                        <input type="text" v-model="form.usdt_image_url" placeholder="åœ¨æ­¤ç²˜è´´æ•™ç¨‹å›¾ç‰‡ç›´é“¾ (ä¾‹å¦‚: https://...)" class="flex-grow bg-slate-900 border border-slate-600 rounded-xl px-4 py-2.5 text-white outline-none focus:border-amber-400 transition font-mono text-sm">
                        <button @click="saveConfig" class="px-6 py-2.5 bg-slate-700 hover:bg-slate-600 text-white font-bold rounded-xl transition shadow-sm whitespace-nowrap">ä¿å­˜å›¾ç‰‡</button>
                    </div>
                    <p class="text-[10px] text-slate-500 mt-2">ç”¨æˆ·åœ¨å……å€¼é¡µé€‰æ‹© USDT æ—¶ï¼Œä¸‹æ–¹å°†å±•ç¤ºè¯¥å›¾ç‰‡ã€‚é¼ æ ‡æ‚¬åœå¯æ”¾å¤§é¢„è§ˆã€‚</p>
                </div>
            </div>
        </div>

        <div class="bg-slate-800/80 border border-slate-700 p-6 md:p-8 rounded-3xl shadow-xl flex flex-col gap-6 w-full">
            <div class="flex items-center space-x-4 border-b border-slate-700 pb-4"><div class="w-12 h-12 bg-blue-500/20 rounded-full flex items-center justify-center text-blue-400 text-2xl shrink-0">âš¡</div><div><h3 class="text-white font-bold text-lg md:text-xl tracking-wide">æ ¸å¿ƒç³»ç»Ÿè¿æ¥é…ç½® (System Core)</h3><p class="text-xs text-slate-400 mt-1">ç¬¬ä¸‰æ–¹æœåŠ¡å‚æ•°é…ç½®ä¸­å¿ƒ (ç®¡ç†å‘˜å¡«å…¥åç”Ÿæ•ˆï¼Œæ¸…ç©ºåˆ™åœæ­¢å·¥ä½œ)</p></div></div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6 w-full">
                <div class="space-y-3 bg-slate-900/30 p-5 rounded-2xl border border-slate-700/50"><h4 class="text-amber-400 font-bold text-sm flex items-center"><span class="mr-2">ğŸ”Œ</span> ä¸Šæ¸¸è´§æº (API)</h4><input type="text" v-model="form.upstream_url" placeholder="API URL" class="w-full bg-slate-900/80 border border-slate-700 rounded-lg p-2.5 text-white outline-none focus:border-amber-400 transition font-mono text-sm"><input type="password" v-model="form.upstream_key" placeholder="API Key" class="w-full bg-slate-900/80 border border-slate-700 rounded-lg p-2.5 text-white outline-none focus:border-amber-400 transition font-mono text-sm"></div>
                <div class="space-y-3 bg-slate-900/30 p-5 rounded-2xl border border-slate-700/50"><h4 class="text-blue-400 font-bold text-sm flex items-center"><span class="mr-2">ğŸ¤–</span> TELEGRAM æœºå™¨äºº</h4><div class="grid grid-cols-2 gap-3"><input type="text" v-model="form.tg_bot_token" placeholder="Bot Token" class="w-full bg-slate-900/80 border border-slate-700 rounded-lg p-2.5 text-white outline-none focus:border-blue-400 transition font-mono text-sm"><input type="text" v-model="form.tg_chat_id" placeholder="Chat ID" class="w-full bg-slate-900/80 border border-slate-700 rounded-lg p-2.5 text-white outline-none focus:border-blue-400 transition font-mono text-sm"></div><input type="text" v-model="form.tg_bot_link" placeholder="Bot Link" class="w-full bg-slate-900/80 border border-slate-700 rounded-lg p-2.5 text-white outline-none focus:border-blue-400 transition font-mono text-sm"></div>
                <div class="space-y-3 bg-slate-900/30 p-5 rounded-2xl border border-slate-700/50"><h4 class="text-emerald-400 font-bold text-sm flex items-center"><span class="mr-2">ğŸ’³</span> æ”¯ä»˜ç½‘å…³</h4><div class="flex space-x-2"><input type="text" v-model="form.cryptomus_id" placeholder="Cryptomus ID" class="w-1/3 bg-slate-900/80 border border-slate-700 rounded-lg p-2.5 text-white outline-none focus:border-emerald-400 text-sm"><input type="password" v-model="form.cryptomus_key" placeholder="Key" class="w-2/3 bg-slate-900/80 border border-slate-700 rounded-lg p-2.5 text-white outline-none focus:border-emerald-400 text-sm"></div><div class="flex space-x-2"><input type="text" v-model="form.bufpay_id" placeholder="BufPay ID" class="w-1/3 bg-slate-900/80 border border-slate-700 rounded-lg p-2.5 text-white outline-none focus:border-emerald-400 text-sm"><input type="password" v-model="form.bufpay_key" placeholder="Secret" class="w-2/3 bg-slate-900/80 border border-slate-700 rounded-lg p-2.5 text-white outline-none focus:border-emerald-400 text-sm"></div></div>
                <div class="space-y-3 bg-slate-900/30 p-5 rounded-2xl border border-slate-700/50"><h4 class="text-purple-400 font-bold text-sm flex items-center"><span class="mr-2">ğŸ“§</span> é‚®ä»¶æœåŠ¡ (SMTP)</h4><div class="grid grid-cols-2 gap-3"><input type="text" v-model="form.smtp_host" placeholder="Host" class="w-full bg-slate-900/80 border border-slate-700 rounded-lg p-2.5 text-white outline-none focus:border-purple-400 text-sm"><input type="text" v-model="form.smtp_port" placeholder="Port" class="w-full bg-slate-900/80 border border-slate-700 rounded-lg p-2.5 text-white outline-none focus:border-purple-400 text-sm"></div><div class="grid grid-cols-2 gap-3"><input type="text" v-model="form.smtp_email" placeholder="Email" class="w-full bg-slate-900/80 border border-slate-700 rounded-lg p-2.5 text-white outline-none focus:border-purple-400 text-sm"><input type="password" v-model="form.smtp_pass" placeholder="Pass" class="w-full bg-slate-900/80 border border-slate-700 rounded-lg p-2.5 text-white outline-none focus:border-purple-400 text-sm"></div></div>
            </div>
            <button @click="saveConfig" class="w-full mt-4 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white font-black text-lg py-4 rounded-xl transition shadow-[0_10px_30px_rgba(79,70,229,0.3)] transform hover:-translate-y-1 tracking-wider">ä¿å­˜ç³»ç»Ÿé…ç½®</button>
        </div>

        <div class="bg-slate-800/80 border border-slate-700 rounded-3xl shadow-xl overflow-hidden mt-6 relative"><div class="p-6 border-b border-slate-700 flex justify-between items-center"><h3 class="text-lg font-bold text-white flex items-center"><span class="text-blue-400 mr-2">ğŸ§¾</span> å…¨ç«™èµ„é‡‘æµæ°´å¤§ç›˜</h3></div><div class="flex justify-between items-center bg-slate-900/50 p-3 border-b border-slate-700"><input type="text" v-model="searchTx" placeholder="æœç´¢ UID / è´¦å· / æ‘˜è¦" class="bg-slate-800 text-white px-3 py-1.5 rounded-lg text-xs border border-slate-600 focus:border-amber-400 outline-none w-64"><div class="flex items-center space-x-2 text-xs text-slate-400"><span>å•é¡µæ˜¾ç¤º</span><select v-model="sizeTx" class="bg-slate-800 text-white px-2 py-1 rounded border border-slate-600 outline-none"><option :value="10">10</option><option :value="20">20</option><option :value="50">50</option></select></div></div><div class="overflow-x-auto custom-scrollbar"><table class="w-full text-left text-sm whitespace-nowrap"><thead class="bg-slate-900/50 text-xs uppercase text-slate-400"><tr><th class="px-6 py-4">æ—¶é—´ (Time)</th><th class="px-6 py-4">ç”¨æˆ·è´¦å·</th><th class="px-6 py-4">å˜åŠ¨é‡‘é¢</th><th class="px-6 py-4">å½“å‰ä½™é¢</th><th class="px-6 py-4">èµ„é‡‘æ‘˜è¦ (ç±»å‹)</th></tr></thead><tbody class="divide-y divide-slate-700/50 text-slate-200"><tr v-for="t in pagedTx" :key="t.id" class="hover:bg-slate-700/30 transition"><td class="px-6 py-4 font-mono text-xs text-amber-400/80 font-bold">{{ formatTime(t.createdAt || t.created_at) }}</td><td class="px-6 py-4 font-bold text-white"><div class="flex items-center"><span class="bg-slate-700 px-1.5 py-0.5 rounded text-[10px] mr-2">UID {{ t.user_id }}</span>{{ t.phone || 'æœªçŸ¥' }}</div></td><td class="px-6 py-4 font-mono font-bold" :class="t.amount > 0 ? 'text-green-400' : 'text-red-400'">{{ t.amount > 0 ? '+' : '' }}{{ t.amount }}</td><td class="px-6 py-4 font-mono text-amber-400 font-bold">{{ t.balance != null ? app.formatMoney(t.balance) : '--' }}</td><td class="px-6 py-4 text-xs"><span class="text-slate-300 font-bold mr-2">{{ t.description }}</span><span class="text-slate-500 font-mono">({{ t.type }})</span></td></tr><tr v-if="pagedTx.length === 0"><td colspan="5" class="text-center py-10 text-slate-500">æš‚æ— èµ„é‡‘å˜åŠ¨è®°å½•</td></tr></tbody></table></div><div class="flex justify-between items-center p-3 bg-slate-900/50 border-t border-slate-700"><span class="text-xs text-slate-400">å…± {{ filteredTx.length }} æ¡è®°å½•ï¼Œç¬¬ {{ pageTx }} / {{ totalPageTx }} é¡µ</span><div class="flex space-x-2"><button @click="pageTx > 1 && pageTx--" :disabled="pageTx === 1" class="px-3 py-1 bg-slate-800 hover:bg-slate-700 text-white rounded text-xs disabled:opacity-50 transition">ä¸Šä¸€é¡µ</button><button @click="pageTx < totalPageTx && pageTx++" :disabled="pageTx === totalPageTx" class="px-3 py-1 bg-slate-800 hover:bg-slate-700 text-white rounded text-xs disabled:opacity-50 transition">ä¸‹ä¸€é¡µ</button></div></div></div>

        <div class="bg-slate-800/80 border border-slate-700 rounded-3xl shadow-xl overflow-hidden mt-6"><div class="p-6 border-b border-slate-700 flex justify-between items-center"><h3 class="text-lg font-bold text-white flex items-center"><span class="text-blue-400 mr-2">ğŸ‘¥</span> å…¨ç«™ç”¨æˆ·ç›‘æ§ä¸èµ„é‡‘ç®¡ç†</h3></div><div class="flex justify-between items-center bg-slate-900/50 p-3 border-b border-slate-700"><input type="text" v-model="searchUser" placeholder="æœç´¢ UID / è´¦å· / é‚®ç®± / IP" class="bg-slate-800 text-white px-3 py-1.5 rounded-lg text-xs border border-slate-600 focus:border-amber-400 outline-none w-64"></div><div class="overflow-x-auto custom-scrollbar"><table class="w-full text-left text-sm whitespace-nowrap"><thead class="bg-slate-900/50 text-xs uppercase text-slate-400"><tr><th class="px-6 py-4">UID/è´¦å·/é‚®ç®±/æ³¨å†ŒIPä¸æ—¶é—´</th><th class="px-6 py-4">æœ€åç™»å½• IP</th><th class="px-6 py-4">ç­‰çº§/åˆ°æœŸæ—¥</th><th class="px-6 py-4">å½“å‰ä½™é¢</th><th class="px-6 py-4">ä¸“å±å€ç‡</th><th class="px-6 py-4 text-center">æ“ä½œ</th></tr></thead><tbody class="divide-y divide-slate-700/50 text-slate-200"><tr v-for="u in pagedUsers" :key="u.id" class="hover:bg-slate-700/30 transition"><td class="px-6 py-4"><div class="font-bold text-white mb-1 flex items-center"><span class="bg-slate-700 px-1.5 py-0.5 rounded text-[10px] mr-2">UID {{ u.id }}</span>{{ u.phone }}</div><div class="text-[10px] text-blue-400 font-mono tracking-tighter mb-0.5 flex items-center"><span class="mr-1">ğŸ“§</span> {{ u.email || 'æœªç»‘å®šé‚®ç®±' }}</div><div class="text-[10px] text-slate-500 font-mono tracking-tighter">æ³¨å†ŒIP: {{ u.register_ip || 'æœªçŸ¥' }} | {{ formatTime(u.createdAt || u.created_at) }}</div></td><td class="px-6 py-4 text-xs font-mono text-amber-400/80">{{ u.last_login_ip || 'æœªç™»å½•' }}</td><td class="px-6 py-4"><div v-if="u.role === 'super_admin'" class="x-badge badge-super inline-flex items-center"><span class="badge-shimmer"></span>{{ app.t('super_admin_badge') || 'è‡³å°Šç®¡ç†å‘˜' }}</div><div v-else-if="u.role === 'admin'" class="x-badge badge-admin inline-flex items-center"><span class="badge-shimmer"></span>{{ app.t('admin_badge') || 'ç®¡ç†å‘˜' }}</div><div v-else-if="u.role === 'agent'" class="flex flex-col items-start"><div class="x-badge badge-agent inline-flex items-center mb-1"><span class="badge-shimmer"></span>{{ app.t('agent_badge') || 'ä»£ç†' }}</div><div class="text-[9px] text-slate-500">{{ u.vip_expire_at ? new Date(u.vip_expire_at).toLocaleDateString() : 'æ— æœŸé™' }}</div></div><div v-else class="x-badge badge-gold inline-flex items-center"><span class="badge-shimmer"></span>{{ app.t('gold_badge') || 'é»„é‡‘ç”¨æˆ·' }}</div></td><td class="px-6 py-4 font-mono text-amber-400 font-bold text-lg bg-slate-900/30">{{ app.formatMoney(u.balance) }}</td><td class="px-6 py-4"><div v-if="['admin', 'super_admin'].includes(u.role)" class="flex flex-col space-y-2"><div class="flex space-x-1.5 items-center"><input type="text" disabled value="1.00" class="w-24 bg-slate-900/50 border border-slate-700/50 rounded-lg py-1.5 px-2 text-center text-xs text-slate-600 font-mono cursor-not-allowed"><span class="text-[10px] text-slate-500 font-bold px-2 py-1.5 bg-slate-800/50 rounded-lg border border-slate-700">ğŸ”’ é”å®š</span></div><div class="text-[10px] text-slate-500">ç›®å‰ç”Ÿæ•ˆ: <span class="text-slate-400 font-bold tracking-wide">1.00x (åŸä»·)</span></div></div><div v-else class="flex flex-col space-y-2"><div class="flex space-x-1.5 items-center"><input type="number" v-model="u.customInput" :placeholder="getDefaultMultiplier(u) + ' (é»˜è®¤)'" step="0.1" class="w-24 bg-slate-900 border border-slate-600 rounded-lg py-1.5 px-2 text-center text-xs outline-none focus:border-amber-400 placeholder:text-slate-600 transition shadow-inner font-mono text-white"><button @click="saveMultiplier(u)" class="text-[10px] bg-slate-700 px-3 py-1.5 rounded-lg text-white font-bold transition hover:bg-amber-400 hover:text-black shadow-sm">ä¿å­˜</button><button v-if="u.custom_multiplier" @click="resetMultiplier(u)" class="text-[10px] bg-red-500/10 text-red-400 border border-red-500/20 px-3 py-1.5 rounded-lg transition hover:bg-red-500 hover:text-white shadow-sm font-bold" title="ä¸€é”®æ¢å¤ç³»ç»Ÿé»˜è®¤å€ç‡">æ¢å¤</button></div><div class="text-[10px] text-slate-400">ç›®å‰ç”Ÿæ•ˆ: <span :class="u.custom_multiplier ? 'text-purple-400 font-black tracking-wide' : 'text-emerald-400 font-bold tracking-wide'">{{ u.custom_multiplier ? parseFloat(u.custom_multiplier).toFixed(2) + 'x (å·²è‡ªå®šä¹‰)' : getDefaultMultiplier(u) + 'x (ç³»ç»Ÿé»˜è®¤)' }}</span></div></div></td><td class="px-6 py-4 text-center space-x-2"><button v-if="!['admin', 'super_admin'].includes(u.role)" @click="openRoleModal(u)" class="text-xs bg-purple-500/10 hover:bg-purple-500/30 text-purple-400 border border-purple-500/30 px-3 py-1.5 rounded transition font-bold shadow-[0_0_10px_rgba(168,85,247,0.1)]">ğŸ‘‘ ææƒ</button><button @click="openFundModal(u, 'add')" class="text-xs bg-green-500/10 hover:bg-green-500/30 text-green-400 border border-green-500/30 px-3 py-1.5 rounded transition font-bold">+ åŠ æ¬¾</button><button @click="openFundModal(u, 'deduct')" class="text-xs bg-red-500/10 hover:bg-red-500/30 text-red-400 border border-red-500/30 px-3 py-1.5 rounded transition font-bold">- æ‰£æ¬¾</button></td></tr></tbody></table></div><div class="flex justify-between items-center p-3 bg-slate-900/50 border-t border-slate-700"><span class="text-xs text-slate-400">å…± {{ filteredUsers.length }} ä½ç”¨æˆ·ï¼Œç¬¬ {{ pageUser }} / {{ totalPageUser }} é¡µ</span><div class="flex space-x-2"><button @click="pageUser > 1 && pageUser--" :disabled="pageUser === 1" class="px-3 py-1 bg-slate-800 hover:bg-slate-700 text-white rounded text-xs disabled:opacity-50 transition">ä¸Šä¸€é¡µ</button><button @click="pageUser < totalPageUser && pageUser++" :disabled="pageUser === totalPageUser" class="px-3 py-1 bg-slate-800 hover:bg-slate-700 text-white rounded text-xs disabled:opacity-50 transition">ä¸‹ä¸€é¡µ</button></div></div></div>

        <div class="bg-slate-800/80 border border-slate-700 rounded-3xl shadow-xl overflow-hidden mt-6 relative"><div class="p-6 border-b border-slate-700 flex justify-between items-center"><h3 class="text-lg font-bold text-white flex items-center"><span class="text-purple-400 mr-2">ğŸ“Š</span> å…¨ç«™å†å²è®¢å•ç›‘æ§æ± </h3><button @click="fetchDashboard(false)" class="text-xs bg-amber-500 hover:bg-amber-600 text-slate-900 font-black px-4 py-2 rounded transition shadow flex items-center">æ‰‹åŠ¨å¼ºåˆ·å¤§ç›˜</button></div><div class="flex justify-between items-center bg-slate-900/50 p-3 border-b border-slate-700"><input type="text" v-model="searchOrder" placeholder="æœç´¢ è®¢å•å· / UID / æœåŠ¡å" class="bg-slate-800 text-white px-3 py-1.5 rounded-lg text-xs border border-slate-600 focus:border-amber-400 outline-none w-64"><div class="flex items-center space-x-2 text-xs text-slate-400"><span>å•é¡µæ˜¾ç¤º</span><select v-model="sizeOrder" class="bg-slate-800 text-white px-2 py-1 rounded border border-slate-600 outline-none"><option :value="10">10</option><option :value="20">20</option><option :value="50">50</option></select></div></div><div class="overflow-x-auto custom-scrollbar"><table class="w-full text-left text-sm whitespace-nowrap"><thead class="bg-slate-900/50 text-xs uppercase text-slate-400"><tr><th class="px-6 py-4">è®¢å•å· / æ—¶é—´</th><th class="px-6 py-4">ä¸‹å•äºº UID</th><th class="px-6 py-4 max-w-xs">æœåŠ¡ (ID) / é“¾æ¥</th><th class="px-6 py-4 text-center">åˆå§‹ / æ•°é‡ / å‰©ä½™</th><th class="px-6 py-4">è´¹ç”¨</th><th class="px-6 py-4 text-right">ä¸Šæ¸¸çŠ¶æ€</th></tr></thead><tbody class="divide-y divide-slate-700/50 text-slate-200"><tr v-for="o in pagedOrders" :key="o.id" class="hover:bg-slate-700/30 transition"><td class="px-6 py-4"><div class="font-mono text-xs text-slate-300">{{ o.order_no }}</div><div class="text-[10px] text-amber-500/80 mt-1 font-mono tracking-tighter">{{ formatTime(o.createdAt || o.created_at) }}</div></td><td class="px-6 py-4 font-bold text-white"><div class="text-xs">{{ o.phone || 'æœªçŸ¥' }}</div><div class="text-[10px] text-slate-500">UID: {{ o.user_id }}</div></td><td class="px-6 py-4" style="max-width: 280px; white-space: normal !important; word-wrap: break-word; word-break: break-all;"><div class="text-xs text-slate-400 mb-1 leading-relaxed"><span v-if="o.service_id" class="text-amber-500 font-bold mr-1">[ID:{{ o.service_id }}]</span><span v-else class="text-slate-500 font-bold mr-1">[ID:æ— ]</span>{{ o.service_name }}</div><a :href="o.link" target="_blank" class="text-[11px] text-blue-400 hover:text-blue-300 transition select-all leading-relaxed block">{{ o.link }}</a></td><td class="px-6 py-4 text-center"><div class="flex items-center justify-center space-x-2 text-xs font-mono bg-slate-900/50 py-1 rounded-lg border border-slate-700/50"><span class="text-slate-500" title="Start">{{ o.start_count || 0 }}</span><span class="text-slate-600">/</span><span class="font-bold text-white" title="Quantity">{{ o.quantity }}</span><span class="text-slate-600">/</span><span class="text-red-400" title="Remains">{{ o.remains || 0 }}</span></div></td><td class="px-6 py-4"><div class="text-xs text-amber-400 font-bold mt-0.5">{{ app.formatMoney(o.charge) }}</div></td><td class="px-6 py-4 text-right"><span class="px-3 py-1 rounded-full text-[10px] font-bold border" :class="o.status === 'è¿›è¡Œä¸­' ? 'bg-blue-500/10 text-blue-400 border-blue-500/20' : o.status === 'å·²å®Œæˆ' ? 'bg-green-500/10 text-green-400 border-green-500/20' : 'bg-red-500/10 text-red-400 border-red-500/20'">{{ o.status }}</span></td></tr><tr v-if="pagedOrders.length === 0"><td colspan="6" class="text-center py-10 text-slate-500">æš‚æ— è®¢å•è®°å½•</td></tr></tbody></table></div><div class="flex justify-between items-center p-3 bg-slate-900/50 border-t border-slate-700"><span class="text-xs text-slate-400">å…± {{ filteredOrders.length }} æ¡è®¢å•ï¼Œç¬¬ {{ pageOrder }} / {{ totalPageOrder }} é¡µ</span><div class="flex space-x-2"><button @click="pageOrder > 1 && pageOrder--" :disabled="pageOrder === 1" class="px-3 py-1 bg-slate-800 hover:bg-slate-700 text-white rounded text-xs disabled:opacity-50 transition">ä¸Šä¸€é¡µ</button><button @click="pageOrder < totalPageOrder && pageOrder++" :disabled="pageOrder === totalPageOrder" class="px-3 py-1 bg-slate-800 hover:bg-slate-700 text-white rounded text-xs disabled:opacity-50 transition">ä¸‹ä¸€é¡µ</button></div></div></div>

        <div v-if="fundModal.show" class="fixed inset-0 z-[10005] flex items-center justify-center bg-black/70 backdrop-blur-sm p-4 animate-fade-in"><div class="bg-slate-900 border border-slate-700 p-8 rounded-3xl shadow-[0_20px_60px_rgba(0,0,0,0.8)] max-w-sm w-full relative transform transition-all scale-100"><button @click="fundModal.show = false" class="absolute top-4 right-4 text-slate-400 hover:text-white"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button><h3 class="text-xl font-black text-white mb-2 tracking-wide text-center">èµ„é‡‘ä¸­å¿ƒæŒ‡ä»¤</h3><p class="text-slate-400 text-sm mb-6 text-center">ç›®æ ‡è´¦æˆ·: <span class="text-amber-400 font-bold">{{ fundModal.phone }}</span></p><div class="space-y-4 mb-8"><div><label class="block text-xs font-bold text-slate-400 mb-1 uppercase tracking-wider">æ“ä½œé‡‘é¢ (CNY)</label><input type="number" v-model="fundModal.amount" class="w-full bg-slate-800 border border-slate-600 rounded-xl px-4 py-3 text-white outline-none focus:border-amber-400 transition font-mono text-lg" placeholder="0.00"></div></div><button @click="submitFund" :class="['w-full font-black text-lg py-3.5 rounded-xl transition transform hover:-translate-y-1 shadow-lg text-slate-900', fundModal.type === 'add' ? 'bg-gradient-to-r from-green-400 to-emerald-500 hover:from-green-500 hover:to-emerald-600 shadow-[0_0_20px_rgba(34,197,94,0.3)]' : 'bg-gradient-to-r from-red-400 to-rose-500 hover:from-red-500 hover:to-rose-600 shadow-[0_0_20px_rgba(239,68,68,0.3)]']">ç¡®è®¤{{ fundModal.type === 'add' ? 'åŠ æ¬¾' : 'æ‰£æ¬¾' }}</button></div></div>
        <div v-if="roleModal.show" class="fixed inset-0 z-[10006] flex items-center justify-center bg-black/70 backdrop-blur-sm p-4 animate-fade-in"><div class="bg-slate-900 border border-slate-700 p-8 rounded-3xl shadow-[0_20px_60px_rgba(0,0,0,0.8)] max-w-md w-full relative transform transition-all scale-100"><button @click="roleModal.show = false" class="absolute top-4 right-4 text-slate-400 hover:text-white"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button><h3 class="text-xl font-black text-white mb-2 tracking-wide text-center">ç”¨æˆ·ç‰¹æƒä¸ç­‰çº§è°ƒåº¦</h3><p class="text-slate-400 text-sm mb-6 text-center">ç›®æ ‡è´¦æˆ·: <span class="text-amber-400 font-bold">{{ roleModal.phone }}</span></p><div class="space-y-6 mb-8"><div><label class="block text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider">åˆ†é…èº«ä»½</label><div class="grid grid-cols-2 gap-3"><button @click="roleModal.role = 'user'; roleModal.addDays = 0" :class="['py-3 rounded-xl border text-sm font-bold transition', roleModal.role === 'user' ? 'bg-slate-700 border-slate-500 text-white shadow-inner' : 'bg-slate-800/50 border-slate-700 text-slate-400 hover:bg-slate-800']">é»„é‡‘ç”¨æˆ·</button><button @click="roleModal.role = 'agent'" :class="['py-3 rounded-xl border text-sm font-bold transition flex flex-col items-center justify-center', roleModal.role === 'agent' ? 'bg-amber-500/20 border-amber-500 text-amber-400 shadow-[0_0_15px_rgba(251,191,36,0.2)]' : 'bg-slate-800/50 border-slate-700 text-slate-400 hover:bg-slate-800']">ğŸ‘‘ è‡³å°Šä»£ç†</button></div></div><div v-if="roleModal.role === 'agent'" class="animate-fade-in space-y-3 p-4 bg-slate-800/50 rounded-2xl border border-amber-500/20"><div class="flex justify-between items-center"><label class="block text-xs font-bold text-amber-400 uppercase tracking-wider">èµ é€ä»£ç†æ—¶é•¿ (å¤©)</label><span class="text-[10px] text-slate-400">ç›®å‰åˆ°æœŸ: {{ roleModal.currentExpire ? new Date(roleModal.currentExpire).toLocaleDateString() : 'æ— ' }}</span></div><div class="grid grid-cols-4 gap-2"><button @click="roleModal.addDays = 7" :class="['py-1.5 rounded-lg border text-xs font-bold transition', roleModal.addDays === 7 ? 'bg-amber-500 text-slate-900 border-amber-400' : 'bg-slate-700 border-slate-600 text-slate-300 hover:bg-slate-600']">+7å¤©</button><button @click="roleModal.addDays = 30" :class="['py-1.5 rounded-lg border text-xs font-bold transition', roleModal.addDays === 30 ? 'bg-amber-500 text-slate-900 border-amber-400' : 'bg-slate-700 border-slate-600 text-slate-300 hover:bg-slate-600']">+1æœˆ</button><button @click="roleModal.addDays = 90" :class="['py-1.5 rounded-lg border text-xs font-bold transition', roleModal.addDays === 90 ? 'bg-amber-500 text-slate-900 border-amber-400' : 'bg-slate-700 border-slate-600 text-slate-300 hover:bg-slate-600']">+1å­£</button><button @click="roleModal.addDays = 365" :class="['py-1.5 rounded-lg border text-xs font-bold transition', roleModal.addDays === 365 ? 'bg-amber-500 text-slate-900 border-amber-400' : 'bg-slate-700 border-slate-600 text-slate-300 hover:bg-slate-600']">+1å¹´</button></div><div class="flex items-center space-x-3 mt-3"><span class="text-xs text-slate-400 whitespace-nowrap">è‡ªå®šä¹‰:</span><input type="number" v-model="roleModal.addDays" min="0" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-1.5 text-amber-400 outline-none focus:border-amber-400 transition font-mono text-sm" placeholder="è¾“å…¥å¤©æ•°"></div><p v-if="roleModal.addDays > 0" class="text-[10px] text-emerald-400 text-right mt-1">å°†åœ¨åŸæ—¶é—´ä¸Šè‡ªåŠ¨ç»­æœŸ {{ roleModal.addDays }} å¤©</p></div></div><button @click="submitRole" class="w-full font-black text-lg py-3.5 rounded-xl transition transform hover:-translate-y-1 shadow-lg text-white bg-gradient-to-r from-purple-500 to-indigo-600 hover:from-purple-400 hover:to-indigo-500 shadow-[0_0_20px_rgba(168,85,247,0.4)]">ç¡®è®¤è°ƒåº¦</button></div></div>
    </div>
</template>
